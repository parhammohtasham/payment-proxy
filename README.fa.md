# ุณุฑูุณ ูพุฑูฺฉุณ ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช ุฒุจุงู

ฺฉ ูฺฉุฑูุณุฑูุณ ุงูู FastAPI ฺฉู ุจู ุนููุงู ูุงุณุท ุจู ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช ุฒุจุงู ู API ุงุตู ุจุฑูุงูู ุดูุง ุนูู ูโฺฉูุฏ. ุงู ุณุฑูุณ callback ูุง ูพุฑุฏุงุฎุช ุฑุง ูุฏุฑุช ฺฉุฑุฏูุ ุชุฑุงฺฉูุดโูุง ุฑุง ุชุฃุฏ ูโฺฉูุฏ ู ูุชุงุฌ ุชุฃุฏ ุดุฏู ุฑุง ุจุง ุงูุถุง ุงููุช HMAC-SHA256 ุจู backend ุดูุง ุงุฑุณุงู ูโฺฉูุฏ.

## ๐ ูฺฺฏโูุง

- **ูพุฑุฏุงุฒุด ุงูู ูพุฑุฏุงุฎุช**: webhook ูุง ุงูุถุง ุดุฏู ุจุง HMAC-SHA256 ุจุฑุง ุงุญุฑุงุฒ ููุช
- **ฺฉูพุงุฑฺฺฏ ุจุง ุฒุจุงู**: ูุฏุฑุช callback ูุง ู ุชุฃุฏ ูพุฑุฏุงุฎุชโูุง ุจุง API ุฒุจุงู
- **ุฑูุน ูุดฺฉู Referrer**: ุญู ูุดฺฉู "ุฏุงููู ุบุฑูุฌุงุฒ" ุฒุจุงู
- **ูุงฺฏ ุฌุงูุน**: ูุงฺฏโูุง ุฏูู ุจุฑุง ุนุจโุงุจ ู ูุธุงุฑุช
- **ุฑุฏุงุฑฺฉุช ุฎูุฏฺฉุงุฑ**: ูุฏุงุช ุฎูุฏฺฉุงุฑ ฺฉุงุฑุจุฑุงู ุจู ุตูุญุงุช ููููุช/ุฎุทุง
- **ุจุฑุฑุณ ุณูุงูุช**: endpoint ูุง ุฏุงุฎู ุจุฑุง ูุธุงุฑุช
- **ุขูุงุฏู Docker**: ุดุงูู Dockerfile ู docker-compose ุจุฑุง ุงุณุชูุฑุงุฑ ุขุณุงู
- **ูุณุชูุฏุงุช API**: ูุณุชูุฏุงุช ุชุนุงูู API ุจุง ุฑุงุจุท Scalar

## ๐ ูพุดโูุงุฒูุง

- Python 3.11+
- ุญุณุงุจ ฺฉุงุฑุจุฑ merchant ุฒุจุงู
- endpoint API ุงุตู ุจุฑูุงูู ุดูุง
- ุจุฑูุงูู frontend ุจุฑุง ุฑุฏุงุฑฺฉุช ฺฉุงุฑุจุฑุงู

## ๐ ุดุฑูุน ุณุฑุน

### ูุตุจ

```bash
# ฺฉููู ฺฉุฑุฏู ูุฎุฒู
git clone https://github.com/yourusername/payment-proxy.git
cd payment-proxy

# ูุตุจ ูุงุจุณุชฺฏโูุง
pip install -r requirements.txt
```

### ูพฺฉุฑุจูุฏ

1. ฺฉูพ ฺฉุฑุฏู ูุงู ููููู environment:
```bash
cp .env.example .env
```

2. ูุฑุงุด `.env` ุจุง ุชูุธูุงุช ุดูุง:
```env
# ุชูุธูุงุช ุฒุจุงู
ZIBAL_MERCHANT_ID=your_merchant_id
ZIBAL_VERIFY_URL=https://gateway.zibal.ir/v1/verify
ZIBAL_PAYMENT_URL=https://gateway.zibal.ir/start/

# ุขุฏุฑุณโูุง ุจุฑูุงูู ุดูุง
TICKETING_API_URL=https://your-api.example.com
TICKETING_FRONTEND_URL=https://your-frontend.example.com

# ุงููุช (ุจุงุฏ ุจุง API ุงุตู ุดูุง ฺฉุณุงู ุจุงุดุฏ)
WEBHOOK_SECRET=your_secure_random_secret_key

# ุงุฎุชุงุฑ
DEBUG=false
```

### ุงุฌุฑุง ูุญู

```bash
# ุญุงูุช ุชูุณุนู
python main.py

# ุง ุจุง uvicorn
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

ุณุฑูุณ ุฏุฑ ุขุฏุฑุณ `http://localhost:8000` ุฏุฑ ุฏุณุชุฑุณ ุฎูุงูุฏ ุจูุฏ

## ๐ณ ุงุณุชูุฑุงุฑ ุจุง Docker

### ุงุณุชูุงุฏู ุงุฒ Docker

```bash
# ุณุงุฎุช image
docker build -t payment-proxy .

# ุงุฌุฑุง container
docker run -p 8000:8000 --env-file .env payment-proxy
```

### ุงุณุชูุงุฏู ุงุฒ Docker Compose

```bash
# ุดุฑูุน ุณุฑูุณ
docker-compose up -d

# ูุดุงูุฏู ูุงฺฏโูุง
docker-compose logs -f

# ุชููู ุณุฑูุณ
docker-compose down
```

## ๐๏ธ ูุนูุงุฑ

```
โโโโโโโโโโโ      โโโโโโโโโโโโ      โโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ
โ ฺฉุงุฑุจุฑ   โโโโโโโถโ Frontend โโโโโโโถโ   Payment   โโโโโโโถโ    Zibal     โ
โโโโโโโโโโโ      โโโโโโโโโโโโ      โ    Proxy    โ      โ   Gateway    โ
     โฒ                              โโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ
     โ                                     โ                      โ
     โ                                     โผ                      โ
     โ                              โโโโโโโโโโโโโโโ              โ
     โ                              โ  Main API   โโโโโโโโโโโโโโโโ
     โ                              โโโโโโโโโโโโโโโ
     โ                                     โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุฌุฑุงู ูพุฑุฏุงุฎุช

1. **ฺฉุงุฑุจุฑ ูพุฑุฏุงุฎุช ุฑุง ุขุบุงุฒ ูโฺฉูุฏ** ุฏุฑ frontend ุดูุง
2. **Frontend ุฑุฏุงุฑฺฉุช ูโฺฉูุฏ** ุจู `/redirect/{trackId}` ุฏุฑ ุงู proxy
3. **Proxy ุฑุฏุงุฑฺฉุช ูโฺฉูุฏ** ุจู ุฏุฑฺฏุงู ุฒุจุงู ุจุง referrer ุตุญุญ
4. **ฺฉุงุฑุจุฑ ูพุฑุฏุงุฎุช ุฑุง ุชฺฉูู ูโฺฉูุฏ** ุฏุฑ ุฒุจุงู
5. **ุฒุจุงู callback ุงุฑุณุงู ูโฺฉูุฏ** ุจู `/api/zibal/callback`
6. **Proxy ุชุฃุฏ ูโฺฉูุฏ** ูพุฑุฏุงุฎุช ุฑุง ุจุง API ุฒุจุงู
7. **Proxy ุงุฑุณุงู ูโฺฉูุฏ** ูุชุฌู ุชุฃุฏ ุดุฏู ุฑุง ุจู API ุงุตู ุดูุง ุงุฒ ุทุฑู webhook
8. **Proxy ุฑุฏุงุฑฺฉุช ูโฺฉูุฏ** ฺฉุงุฑุจุฑ ุฑุง ุจู ุตูุญู ููููุช/ุฎุทุง ุฏุฑ frontend ุดูุง

## ๐ก Endpoint ูุง API

### `GET /`
ุงุทูุงุนุงุช ู ูุถุนุช ุณุฑูุณ

### `GET /health`
endpoint ุจุฑุฑุณ ุณูุงูุช ุจุฑุง ุณุณุชูโูุง ูุธุงุฑุช

### `GET /docs`
ูุณุชูุฏุงุช ุชุนุงูู API (ุฑุงุจุท Scalar)

### `GET /redirect/{trackId}`
ุฑุฏุงุฑฺฉุช ุจู ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช ุฒุจุงู
- **ูุฏู**: ุญู ูุดฺฉู "ุฏุงููู ุบุฑูุฌุงุฒ"
- **ูพุงุฑุงูุชุฑูุง**: 
  - `trackId`: ุดูุงุณู ุชุฑุงฺฉูุด ุงุฒ ุฒุจุงู

### `GET /api/zibal/callback`
ุฏุฑุงูุช callback ูพุฑุฏุงุฎุช ุงุฒ ุฒุจุงู
- **ูพุงุฑุงูุชุฑูุง**:
  - `trackId`: ุดูุงุณู ุชุฑุงฺฉูุด
  - `success`: ูุถุนุช ูพุฑุฏุงุฎุช (1=ููููุ 0=ูุงูููู)
  - `status`: ฺฉุฏ ูุถุนุช ุชุฑุงฺฉูุด
  - `orderId`: ุดูุงุณู ุณูุงุฑุด (ุงุฎุชุงุฑ)

## ๐ ุงููุช

### ุงูุถุง HMAC

ุชูุงู ุฏุฑุฎูุงุณุชโูุง webhook ุจู API ุงุตู ุดูุง ุจุง HMAC-SHA256 ุงูุถุง ูโุดููุฏ:

```python
signature = hmac.new(
    WEBHOOK_SECRET.encode(),
    f"{trackId}:{success}:{status}".encode(),
    hashlib.sha256
).hexdigest()
```

ุงูุถุง ุฏุฑ header ุจุง ูุงู `X-Webhook-Signature` ุงุฑุณุงู ูโุดูุฏ.

### ุชุฃุฏ Webhook ูุง ุฏุฑ API ุดูุง

```python
import hmac
import hashlib

def verify_webhook(data, signature, secret):
    message = f"{data['trackId']}:{data['success']}:{data['status']}"
    expected = hmac.new(
        secret.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(signature, expected)
```

## ๐ง ุฑุงูููุง ูพฺฉุฑุจูุฏ

| ูุชุบุฑ | ุชูุถุญุงุช | ุงูุฒุงู | ูพุดโูุฑุถ |
|-------|---------|--------|---------|
| `ZIBAL_MERCHANT_ID` | ุดูุงุณู merchant ุฒุจุงู ุดูุง | ุจูู | `zibal` |
| `ZIBAL_VERIFY_URL` | endpoint ุชุฃุฏ ุฒุจุงู | ุฎุฑ | `https://gateway.zibal.ir/v1/verify` |
| `ZIBAL_PAYMENT_URL` | ุขุฏุฑุณ ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช ุฒุจุงู | ุฎุฑ | `https://gateway.zibal.ir/start/` |
| `TICKETING_API_URL` | ุขุฏุฑุณ ูพุงู API ุงุตู ุดูุง | ุจูู | - |
| `TICKETING_FRONTEND_URL` | ุขุฏุฑุณ ูพุงู frontend ุดูุง | ุจูู | - |
| `WEBHOOK_SECRET` | ฺฉูุฏ ูุดุชุฑฺฉ ุจุฑุง ุงูุถุงูุง HMAC | ุจูู | - |
| `DEBUG` | ูุนุงูโุณุงุฒ ุญุงูุช debug | ุฎุฑ | `false` |

## ๐ ุงุณุชูุฑุงุฑ

### ูพฺฉุฑุจูุฏ ุฒุจุงู

1. ูุงุฑุฏ ูพูู merchant ุฒุจุงู ุดูุฏ
2. ุขุฏุฑุณ callback ุฑุง ุชูุธู ฺฉูุฏ: `https://your-domain.com/api/zibal/callback`
3. ุฏุงููู ุฎูุฏ ุฑุง ุจู ูุณุช ุฏุงูููโูุง ูุฌุงุฒ ุงุถุงูู ฺฉูุฏ

### ูพูุชูุฑูโูุง ุงุจุฑ

#### ูุงุฑุง (PaaS ุงุฑุงู)

```bash
# ูุตุจ CLI ูุงุฑุง
npm install -g @liara/cli

# ูุฑูุฏ
liara login

# ุงุณุชูุฑุงุฑ
liara deploy
```

#### Heroku

```bash
# ุงุฌุงุฏ ุจุฑูุงูู
heroku create your-app-name

# ุชูุธู ูุชุบุฑูุง ูุญุท
heroku config:set ZIBAL_MERCHANT_ID=your_merchant_id
heroku config:set TICKETING_API_URL=https://your-api.com
# ... ุชูุธู ุณุงุฑ ูุชุบุฑูุง

# ุงุณุชูุฑุงุฑ
git push heroku main
```

#### AWS / GCP / Azure

ุงุฒ `Dockerfile` ุงุฑุงุฆู ุดุฏู ุจุฑุง ุงุณุชูุฑุงุฑ ุจู ุนููุงู ุณุฑูุณ container ุงุณุชูุงุฏู ฺฉูุฏ.

## ๐ ูุธุงุฑุช

### ุจุฑุฑุณ ุณูุงูุช

ุณุฑูุณ ุดุงูู endpoint ูุง ุจุฑุฑุณ ุณูุงูุช ุงุณุช:
- `GET /health` - ุจุฑูโฺฏุฑุฏุงูุฏ `{"status": "healthy"}`
- ุจุฑุฑุณ ุณูุงูุช Docker ุฏุฑ Dockerfile ูพฺฉุฑุจูุฏ ุดุฏู ุงุณุช

### ูุงฺฏโฺฏุฐุงุฑ

ุชูุงู ุนููุงุช ูพุฑุฏุงุฎุช ุจุง ุงุทูุงุนุงุช ุฏูู ูุงฺฏ ูโุดููุฏ:
- ุฏุฑุงูุช callback
- ุฏุฑุฎูุงุณุชโูุง/ูพุงุณุฎโูุง ุชุฃุฏ ุฒุจุงู
- ุงุฑุณุงู webhook
- ุฑุฏุงุฑฺฉุช ฺฉุงุฑุจุฑุงู
- ุฎุทุงูุง ู ุงุณุชุซูุงูุง

## ๐งช ุชุณุช

### ุชุณุช ุฏุณุช

```bash
# ุชุณุช endpoint ุณูุงูุช
curl http://localhost:8000/health

# ุชุณุช ุงุทูุงุนุงุช ุณุฑูุณ
curl http://localhost:8000/
```

### ุชุณุช ุฌุฑุงู ูพุฑุฏุงุฎุช

1. ฺฉ ูพุฑุฏุงุฎุช ุชุณุช ุฏุฑ ุจุฑูุงูู ุงุตู ุฎูุฏ ุงุฌุงุฏ ฺฉูุฏ
2. `trackId` ุฑุง ุงุฒ ุฒุจุงู ุฏุฑุงูุช ฺฉูุฏ
3. ุจู `http://localhost:8000/redirect/{trackId}` ุจุฑูุฏ
4. ูพุฑุฏุงุฎุช ุฑุง ุฏุฑ ุฒุจุงู ุชฺฉูู ฺฉูุฏ (ุฏุฑ ุตูุฑุช ุงุณุชูุงุฏู ุงุฒ ุญุงูุช sandbox ุงุฒ ฺฉุงุฑุช ุชุณุช ุงุณุชูุงุฏู ฺฉูุฏ)
5. ูุงฺฏโูุง ุฑุง ุจุฑุง ุชุฃุฏ ูพุฑุฏุงุฒุด callback ู webhook ุจุฑุฑุณ ฺฉูุฏ

## ๐ค ูุดุงุฑฺฉุช

ูุดุงุฑฺฉุชโูุง ุฎูุดโุขูุฏ ูุณุชูุฏ! ูุทูุงู ุจุง ุฎุงู ุฑุงุญุช ฺฉ Pull Request ุงุฑุณุงู ฺฉูุฏ.

1. ูุฎุฒู ุฑุง Fork ฺฉูุฏ
2. ุดุงุฎู ูฺฺฏ ุฎูุฏ ุฑุง ุงุฌุงุฏ ฺฉูุฏ (`git checkout -b feature/AmazingFeature`)
3. ุชุบุฑุงุช ุฎูุฏ ุฑุง commit ฺฉูุฏ (`git commit -m 'Add some AmazingFeature'`)
4. ุจู ุดุงุฎู push ฺฉูุฏ (`git push origin feature/AmazingFeature`)
5. ฺฉ Pull Request ุจุงุฒ ฺฉูุฏ

## ๐ ูุฌูุฒ

ุงู ูพุฑูฺู ุชุญุช ูุฌูุฒ MIT ููุชุดุฑ ุดุฏู ุงุณุช - ุจุฑุง ุฌุฒุฆุงุช ูุงู [LICENSE](LICENSE) ุฑุง ุจุจูุฏ.

## ๐ ูุฏุฑุฏุงู

- [FastAPI](https://fastapi.tiangolo.com/) - ูุฑูโูุฑฺฉ ูุฏุฑู ูุจ ุจุฑุง ุณุงุฎุช API ูุง
- [Zibal](https://zibal.ir/) - ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช ุงุฑุงู
- [Scalar](https://scalar.com/) - ูุณุชูุฏุงุช ุฒุจุง API

## ๐ ูพุดุชุจุงู

ุงฺฏุฑ ุณุคุงู ุง ูุดฺฉู ุฏุงุฑุฏุ ูุทูุงู ฺฉ issue ุฏุฑ GitHub ุจุงุฒ ฺฉูุฏ.

---

**ุชูุฌู**: ุงู ฺฉ ุณุฑูุณ proxy ุงุณุช ฺฉู ุจู ุทูุฑ ุฎุงุต ุจุฑุง ุฏุฑฺฏุงู ูพุฑุฏุงุฎุช ุฒุจุงู ุทุฑุงุญ ุดุฏู ุงุณุช. ูุทูุฆู ุดูุฏ ฺฉู ุญุณุงุจ merchant ุฒุจุงู ุฎูุฏ ุฑุง ุจู ุฏุฑุณุช ูพฺฉุฑุจูุฏ ฺฉุฑุฏู ู `WEBHOOK_SECRET` ุฎูุฏ ุฑุง ุงูู ูฺฏู ุฏุงุฑุฏ.
